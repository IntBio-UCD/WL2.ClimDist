---
title: "Climate_corrs_pcas"
author: "Brandie QC"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Code for Figures 1 and S1; Table S2 and S3 

## Load libraries
```{r}
library(tidyverse)
library(ggrepel) #for repelling labels 
library(corrplot) #plotting correlations 
library(vegan) #for permanova 
library(ggfortify) #plotting PCAs

#making topo maps:
library(elevatr)
library(terra)
library(sf)
library(giscoR)
library(marmap)
```

## Load Climate Data
```{r}
all_clim <- read_csv("../Processed.Data/Climate/All_Clim.csv")
```

## Map of populations (Figure 1a)
```{r}
pops_garden_locs <- all_clim %>% 
  mutate_at(c("Lat", "Long"), as.double) %>% 
  select(parent.pop:Long) %>%
  filter(!is.na(Lat), !is.na(Long)) %>% 
  distinct()
states <- map_data("state") %>% filter(region == "california")

ggplot() +
  geom_polygon(data = states, aes(x = long, y = lat, group = group), fill = "gray") +
  coord_quickmap(xlim = c(-125, -114), ylim = c(35.8, 41))+
  geom_point(data = pops_garden_locs,
             aes(x = Long, y = Lat, color=elev_m),
             size = 3) +
  geom_label_repel(data = pops_garden_locs,
         aes(x = Long, y = Lat,
             label = `parent.pop`),
         min.segment.length = 0,
         max.overlaps = 100,
         #force = 3,
         box.padding = 0.4,
         label.padding = 0.15,
         label.size = 0.1,
         size = 3) +
  labs(color="Elevation (m)") +
  scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  theme_void()
ggsave("../Figures/Pop_Map_Figure1a.png", width = 10, height = 10, units = "in")
```

## Climate variable correlations (Figure S1)

### Calculate 30 year climate averages 
```{r}
all_clim_avgs <- all_clim %>% 
  select(-Lat, -Long) %>% 
  filter(parent.pop!="WL2_Garden") %>% #remove the garden 
  left_join(pops_garden_locs) %>% #add in Lat Long for growth season rows 
  group_by(parent.pop, elevation.group, elev_m, Lat, Long, 
           timeframe, Season) %>% 
  summarise_at(c("cwd",  "pck", "ppt", "tmn", "tmx",
                 "ann_tmean", "mean_diurnal_range", "temp_seasonality", "temp_ann_range",
                 "tmean_wettest_month", "tmean_driest_month", "ann_ppt",
                 "ppt_seasonality","ppt_warmest_month", "ppt_coldest_month"), 
               c(mean), na.rm = TRUE)
```

### Recent Corrs - Water Year
```{r}
recent_wtr_yr_avgs_normalized <- all_clim_avgs %>% 
  filter(timeframe=="recent", Season=="Water Year") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_recent_wtr_yr = cor(recent_wtr_yr_avgs_normalized) #test correlations among the traits
cor.sig_recent_wtr_yr <- cor.mtest(recent_wtr_yr_avgs_normalized, method = "pearson") #get pearson's test p-values 

corrplot(cor.norm_recent_wtr_yr, type="upper",
         tl.srt = 45, p.mat = cor.sig_recent_wtr_yr$p, 
         sig.level = 0.05, insig="blank")
#800 x 734
```

### Historical Corrs - Water year
```{r}
historic_wtr_yr_avgs_normalized <- all_clim_avgs %>% 
  filter(timeframe=="historic", Season=="Water Year") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_historic_wtr_yr = cor(historic_wtr_yr_avgs_normalized) #test correlations among the traits
cor.sig_historic_wtr_yr <- cor.mtest(historic_wtr_yr_avgs_normalized, method = "pearson") #get pearson's test p-values 

corrplot(cor.norm_historic_wtr_yr, type="upper",
         tl.srt = 45, p.mat = cor.sig_historic_wtr_yr$p, 
         sig.level = 0.05, insig="blank")
#800 x 734
```

### Recent Corrs - Growth Season
```{r}
recent_grwssn_avgs_normalized <- all_clim_avgs %>% 
  filter(timeframe=="recent", Season=="Growth Season") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_recent_grwssn = cor(recent_grwssn_avgs_normalized) #test correlations among the traits
cor.sig_recent_grwssn <- cor.mtest(recent_grwssn_avgs_normalized, method = "pearson") #get pearson's test p-values 

corrplot(cor.norm_recent_grwssn, type="upper",
         tl.srt = 45, p.mat = cor.sig_recent_grwssn$p, 
         sig.level = 0.05, insig="blank")
#800 x 734
```

### Historical Corrs - Growth Season
```{r}
historic_grwssn_avgs_normalized <- all_clim_avgs %>% 
  filter(timeframe=="historic", Season=="Growth Season") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_historic_grwssn = cor(historic_grwssn_avgs_normalized) #test correlations among the traits
cor.sig_historic_grwssn <- cor.mtest(historic_grwssn_avgs_normalized, method = "pearson") #get pearson's test p-values 

corrplot(cor.norm_historic_grwssn, type="upper",
         tl.srt = 45, p.mat = cor.sig_historic_grwssn$p, 
         sig.level = 0.05, insig="blank")
#800 x 734
```

## Climate Change PCAs (Figure 1b-c; Table S2, S3)

### Water Year PCA
```{r}
wtr_yr_avgs_normalized <- all_clim_avgs %>% 
  filter(Season=="Water Year") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_wtr_yr = cor(wtr_yr_avgs_normalized) #test correlations among the traits
cor.sig_wtr_yr <- cor.mtest(wtr_yr_avgs_normalized, method = "pearson") #get pearson's test p-values 
cor.norm_wtr_yr
cor.sig_wtr_yr$p
#ann_ppt and ppt 100% correlated (ppt = avg across monts, ann_ppt = avg of the total ppt in a year) - only keep ann_ppt 
#tmn, tmx, tmean_wettest_month, tmean_driest_month and ann_tmean all highly correlated (97-99%) - only keep ann_tmean 
#ppt warmest month highly neg correlated with tmn, ann_tmean, tmean_driest - take it out 
#temp ann range and mean diurnal range highly corr - keep temp_ann_range

wtr_yr_avgs <- all_clim_avgs %>% 
  filter(Season=="Water Year") %>% 
  ungroup()
wtr_yr_avgs.pc = prcomp(wtr_yr_avgs[c(8:9, 13, 15:16, 19:20, 22)], scale = TRUE, center = TRUE)
summary(wtr_yr_avgs.pc)
tibble(PC=str_c("PC",str_pad(1:8,2,pad="0")),
       percent_var=wtr_yr_avgs.pc$sdev[1:8]^2/sum(wtr_yr_avgs.pc$sdev^2)*100) %>%
  ggplot(aes(x=PC, y=percent_var)) +
  geom_col() +
  ggtitle("Percent Variance Explained")

#combine pcs with metadata
wtr_yr_avgs.pc.dat = data.frame(wtr_yr_avgs.pc$x)
wtr_yr_avgs_locs.pc = cbind(wtr_yr_avgs, wtr_yr_avgs.pc.dat)
wtr_yr_avgs_loadings = data.frame(varnames=rownames(wtr_yr_avgs.pc$rotation), wtr_yr_avgs.pc$rotation)
wtr_yr_avgs_loadings
```

#### Permanova 
```{r}
wtr_yr_avgs_locs.pc_dist <- wtr_yr_avgs_locs.pc %>% ungroup() %>% select(PC1:PC8)
dist_matrix_wtr_year <- dist(wtr_yr_avgs_locs.pc_dist, method = "euclidian") #use a distance function to calculate euclidian distance in PCA space
permanova_results_wtr_year <- adonis2(dist_matrix_wtr_year ~ timeframe*elev_m*Lat, data = wtr_yr_avgs_locs.pc) #use adonis2 to run the permanova
permanova_results_wtr_year #look at output 
#get stats per term in the model:
permanova_results_wtr_year_terms <- adonis2(dist_matrix_wtr_year ~ timeframe*elev_m*Lat, data = wtr_yr_avgs_locs.pc, by = "terms")
permanova_results_wtr_year_terms

#LM on PCs (follow up on permanova)
lmer_results_wtr_year <- wtr_yr_avgs_locs.pc %>%
  ungroup() %>% 
  select(timeframe, parent.pop, elev_m, Lat, Long, PC1:PC8) %>% 
  pivot_longer(starts_with("PC", ignore.case = FALSE), 
               names_to = "PC", values_to = "value") %>% 
  group_by(PC) %>% 
  nest(data=c(timeframe, parent.pop, elev_m, Lat, Long, value)) %>% 
  mutate(glm=map(data, ~ glm(value ~ timeframe*elev_m*Lat,
                               data=.x)),
         anova = map(glm, ~ broom.mixed::tidy(anova(.x))))

PC_anova_wtr_yr <- lmer_results_wtr_year %>% select(-data, -glm) %>% unnest(anova) %>%
  select(PC, term, p.value) %>%
  filter(p.value < 0.05) %>%
  arrange(term, p.value)
PC_anova_wtr_yr #PC2 and PC4 most sig, PC1 and PC7 also have sig timeframe effects 
```

#### Plot climate change PCA
```{r}
#prep the pc for making a plot with arrows distinguishing recent vs. historical time 
wtr_yr_avgs_locs.pc_avg <- wtr_yr_avgs_locs.pc %>%
  group_by(parent.pop, elev_m, timeframe) %>%
  summarise(across(.cols=starts_with("PC", ignore.case = FALSE), .fns = mean)) %>%
  ungroup()

autoplot(wtr_yr_avgs.pc, data = wtr_yr_avgs,
         x=1, y=2,
         colour='elev_m', alpha=0.5,
         label=TRUE, label.label="parent.pop",
         loadings=TRUE, loadings.colour='black', loadings.linewidth = 0.7,
         loadings.label = TRUE, loadings.label.size=6, loadings.label.colour="black", 
         loadings.label.vjust = -0.2, loadings.label.repel=TRUE) +
   scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed") +
  theme_classic()

autoplot(wtr_yr_avgs.pc, data = wtr_yr_avgs,
         x=2, y=4,
         colour='elev_m', alpha=0.5,
         label=TRUE, label.label="parent.pop",
         loadings=TRUE, loadings.colour='black', loadings.linewidth = 0.7,
         loadings.label = TRUE, loadings.label.size=6, loadings.label.colour="black", 
         loadings.label.vjust = -0.2, loadings.label.repel=TRUE) +
   scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed") +
  theme_classic()

autoplot(wtr_yr_avgs.pc, data = wtr_yr_avgs,
         x=1, y=4,
         colour='elev_m', alpha=0.5,
         label=TRUE, label.label="parent.pop",
         loadings=TRUE, loadings.colour='black', loadings.linewidth = 0.7,
         loadings.label = TRUE, loadings.label.size=6, loadings.label.colour="black", 
         loadings.label.vjust = -0.2, loadings.label.repel=TRUE) +
   scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed") +
  theme_classic()

wtr_yr_avgs_locs.pc_avg %>% 
  mutate(group=str_c(parent.pop,elev_m))  %>%
  ggplot(aes(x=PC1, y=PC2, shape=timeframe, color=elev_m)) +
  scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_point(size=2, alpha=0.7) +
  geom_text_repel(aes(label = parent.pop)) +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed")  +
  geom_path(aes(group=group),arrow = arrow(length=unit(5, "points")), linewidth = .8)

wtr_yr_avgs_locs.pc_avg %>% 
  mutate(group=str_c(parent.pop,elev_m))  %>%
  ggplot(aes(x=PC2, y=PC4, shape=timeframe, color=elev_m)) +
  scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_point(size=2, alpha=0.7) +
  geom_text_repel(aes(label = parent.pop)) +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed")  +
  geom_path(aes(group=group),arrow = arrow(length=unit(5, "points")), linewidth = .8)

wtr_yr_avgs_locs.pc_avg %>% 
  mutate(group=str_c(parent.pop,elev_m))  %>%
  ggplot(aes(x=PC1, y=PC4, shape=timeframe, color=elev_m)) +
  scale_colour_gradient(low = "#F5A540", high = "#0043F0") +
  geom_point(size=2, alpha=0.7) +
  geom_text_repel(aes(label = parent.pop)) +
  geom_vline(xintercept = 0, linetype="dashed") + geom_hline(yintercept = 0, linetype="dashed")  +
  geom_path(aes(group=group),arrow = arrow(length=unit(5, "points")), linewidth = .8)
```

### Growth Season PCA
```{r}
grwssn_avgs_normalized <- all_clim_avgs %>% 
  filter(Season=="Growth Season") %>% 
  ungroup() %>% 
  select(cwd:ppt_coldest_month) %>% 
  scale() #center and scale the data 

cor.norm_grwssn = cor(grwssn_avgs_normalized) #test correlations among the traits
cor.sig_grwssn <- cor.mtest(grwssn_avgs_normalized, method = "pearson") #get pearson's test p-values 
cor.norm_grwssn
cor.sig_grwssn$p

#tmn, tmx, tmean_driest_month and ann_tmean all highly correlated (90-98%) - only keep ann_tmean 
```


## WL2 Yearly Variation PCAs (Figure S2)
```{r}

```
