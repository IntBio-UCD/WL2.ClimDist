---
title: "Clim_dist_fitness_models"
author: "Brandie QC"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Code for models relating climate distance to fitness (Table 1-2)

## Libraries
```{r}
library(tidyverse)
library(lmerTest) #mixed models
library(broom.mixed) #tidy mixed model results 
library(tidymodels) #model workflows 
library(multilevelmod)
```

## Read in Data
```{r}
wl2_establishment <- read_csv("../Processed.Data/WL2_Establishment.csv")
first_yr_surv <- read_csv("../Processed.Data/WL2_Y1Surv.csv")

winter_surv <- read_csv("../Processed.Data/WL2_WinterSurv.csv")
wl2_surv_to_bud_y2 <- read_csv("../Processed.Data/WL2_Surv_to_Rep_Y2.csv")
wl2_fruits_y2 <- read_csv("../Processed.Data/WL2_Fruits_Y2.csv")

wl2_prob_rep <- read_csv("../Processed.Data/WL2_ProbFit.csv") %>% 
  rename(AvgGD_Recent_Wtr_Year=`AvgGD_Recent_Water Year`,
         AvgGD_Recent_GrwSsn=`AvgGD_Recent_Growth Season`,
         AvgGD_Historic_Wtr_Year=`AvgGD_Historic_Water Year`,
         AvgGD_Historic_GrwSsn=`AvgGD_Historic_Growth Season`)
wlt_tot_fitness <- read_csv("../Processed.Data/WL2_TotalRepOutput.csv") %>% 
  rename(AvgGD_Recent_Wtr_Year=`AvgGD_Recent_Water Year`,
         AvgGD_Recent_GrwSsn=`AvgGD_Recent_Growth Season`,
         AvgGD_Historic_Wtr_Year=`AvgGD_Historic_Water Year`,
         AvgGD_Historic_GrwSsn=`AvgGD_Historic_Growth Season`)

```

## Scale Predictors and Data Transformations
```{r}
wl2_establishment_scaled <- wl2_establishment %>% 
  mutate_at(c("GD_Recent_Wtr_Year_2023", "GD_Historic_Wtr_Year_2023",
              "GD_Recent_GrwSsn_2023", "GD_Historic_GrwSsn_2023",
              "TempDist_Historic_GrwSsn_2023", "TempDist_Historic_Wtr_Year_2023",
              "TempDist_Recent_GrwSsn_2023", "TempDist_Recent_Wtr_Year_2023",
              "PPTDist_Historic_GrwSsn_2023", "PPTDist_Historic_Wtr_Year_2023",
              "PPTDist_Recent_GrwSsn_2023", "PPTDist_Recent_Wtr_Year_2023",
              "Geographic_Dist"), scale)

wl2_y1_surv_scaled <- first_yr_surv %>% 
  mutate_at(c("GD_Recent_Wtr_Year_2023", "GD_Historic_Wtr_Year_2023",
              "GD_Recent_GrwSsn_2023", "GD_Historic_GrwSsn_2023",
              "TempDist_Historic_GrwSsn_2023", "TempDist_Historic_Wtr_Year_2023",
              "TempDist_Recent_GrwSsn_2023", "TempDist_Recent_Wtr_Year_2023",
              "PPTDist_Historic_GrwSsn_2023", "PPTDist_Historic_Wtr_Year_2023",
              "PPTDist_Recent_GrwSsn_2023", "PPTDist_Recent_Wtr_Year_2023",
              "Geographic_Dist"), scale)

wl2_winter_surv_scaled <- winter_surv %>% 
  filter(pop!="WR") %>% #remove pops with too low sample size 
  mutate_at(c("GD_Recent_Wtr_Year_2024", "GD_Historic_Wtr_Year_2024",
              "TempDist_Historic_Wtr_Year_2024","TempDist_Recent_Wtr_Year_2024",
              "PPTDist_Historic_Wtr_Year_2024", "PPTDist_Recent_Wtr_Year_2024",
              "Geographic_Dist"), scale)

wl2_surv_to_rep_y2_scaled <- wl2_surv_to_bud_y2 %>% 
  filter(pop != "LV1", pop != "SQ1", pop != "WR") %>% #remove pops with too low sample size 
  mutate_at(c("GD_Recent_Wtr_Year_2024", "GD_Historic_Wtr_Year_2024",
              "GD_Recent_GrwSsn_2024", "GD_Historic_GrwSsn_2024",
              "TempDist_Historic_GrwSsn_2024", "TempDist_Historic_Wtr_Year_2024",
              "TempDist_Recent_GrwSsn_2024", "TempDist_Recent_Wtr_Year_2024",
              "PPTDist_Historic_GrwSsn_2024", "PPTDist_Historic_Wtr_Year_2024",
              "PPTDist_Recent_GrwSsn_2024", "PPTDist_Recent_Wtr_Year_2024",
              "Geographic_Dist"), scale)

wl2_fruits_y2_scaled <- wl2_fruits_y2 %>% 
  filter(pop!="LV1", pop!="SQ1", pop!="WR") %>% #remove pops with too low sample size 
  mutate(logFruits=log(y2_fruits)) %>%  #transform fruit number with a log transformation 
  mutate_at(c("GD_Recent_Wtr_Year_2024", "GD_Historic_Wtr_Year_2024",
              "GD_Recent_GrwSsn_2024", "GD_Historic_GrwSsn_2024",
              "TempDist_Historic_GrwSsn_2024", "TempDist_Historic_Wtr_Year_2024",
              "TempDist_Recent_GrwSsn_2024", "TempDist_Recent_Wtr_Year_2024",
              "PPTDist_Historic_GrwSsn_2024", "PPTDist_Historic_Wtr_Year_2024",
              "PPTDist_Recent_GrwSsn_2024", "PPTDist_Recent_Wtr_Year_2024",
              "Geographic_Dist"), scale)
  
wl2_FrFlN_y2_scaled <- wl2_fruits_y2 %>% 
  filter(pop!="LV1", pop!="SQ1", pop!="WR") %>% #remove pops with too low sample size 
  drop_na(FrFlN_y2) %>% 
  mutate(logFrFLs=log(FrFlN_y2)) %>% #transform fruit number with a log transformation 
  mutate_at(c("GD_Recent_Wtr_Year_2024", "GD_Historic_Wtr_Year_2024",
              "GD_Recent_GrwSsn_2024", "GD_Historic_GrwSsn_2024",
              "TempDist_Historic_GrwSsn_2024", "TempDist_Historic_Wtr_Year_2024",
              "TempDist_Recent_GrwSsn_2024", "TempDist_Recent_Wtr_Year_2024",
              "PPTDist_Historic_GrwSsn_2024", "PPTDist_Historic_Wtr_Year_2024",
              "PPTDist_Recent_GrwSsn_2024", "PPTDist_Recent_Wtr_Year_2024",
              "Geographic_Dist"), scale)

wl2_prob_fitness_scaled <- wl2_prob_rep %>% 
  mutate_at(c("AvgGD_Historic_GrwSsn", "AvgGD_Historic_Wtr_Year",
              "AvgGD_Recent_GrwSsn", "AvgGD_Recent_Wtr_Year",
              "AvgTempDist_Historic_GrwSsn", "AvgTempDist_Historic_Wtr_Year",
              "AvgTempDist_Recent_GrwSsn", "AvgTempDist_Recent_Wtr_Year",
              "AvgPPTDist_Historic_GrwSsn", "AvgPPTDist_Historic_Wtr_Year",
              "AvgPPTDist_Recent_GrwSsn", "AvgPPTDist_Recent_Wtr_Year",
              "Geographic_Dist"), scale)

wl2_rep_output_scaled <- wlt_tot_fitness %>% 
  mutate(logTotalFitness=log(Total_Fitness)) %>% 
  filter(pop!="SQ1", pop!="WR") %>% 
  mutate_at(c("AvgGD_Historic_GrwSsn", "AvgGD_Historic_Wtr_Year",
              "AvgGD_Recent_GrwSsn", "AvgGD_Recent_Wtr_Year",
              "AvgTempDist_Historic_GrwSsn", "AvgTempDist_Historic_Wtr_Year",
              "AvgTempDist_Recent_GrwSsn", "AvgTempDist_Recent_Wtr_Year",
              "AvgPPTDist_Historic_GrwSsn", "AvgPPTDist_Historic_Wtr_Year",
              "AvgPPTDist_Recent_GrwSsn", "AvgPPTDist_Recent_Wtr_Year",
              "Geographic_Dist"), scale)
```

## Set Model Engines
```{r}
glmer.model_binomial <- 
  linear_reg() %>% 
  set_engine("glmer", family=binomial)
```

## Establishment Models
```{r}
#basic model workflow 
surv_wflow <- workflow() %>% 
  add_variables(outcomes = Establishment, predictors = c(pop, mf, block))
surv_fits <- tibble(wflow=list(
  pop.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ (1|pop) + (1|block))},
  
  pop.mf.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ (1|pop/mf) + (1|block))}
),
name=names(wflow)
) %>% 
  select(name,wflow)
surv_fits_wl2 <- surv_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_establishment_scaled))
surv_fits_wl2 %>% filter(name=="pop.mf.block") %>% pull(fit) #mf explains very little variation and get singularity warning

#Add in Geo and tmp/ppt dist
surv_GD_wflow_sub <- workflow() %>%
  add_variables(outcomes = Establishment, predictors = c(pop, mf, block, contains("Dist"))) 
surv_GD_fits_sub <- tibble(wflow=list(
  pop.block = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ (1|pop) + (1|block))},
  
  GS_Recent = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ TempDist_Recent_GrwSsn_2023 + PPTDist_Recent_GrwSsn_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  GS_Historical = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ TempDist_Historic_GrwSsn_2023 + PPTDist_Historic_GrwSsn_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ TempDist_Recent_Wtr_Year_2023 + PPTDist_Recent_Wtr_Year_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ TempDist_Historic_Wtr_Year_2023 + PPTDist_Historic_Wtr_Year_2023 + Geographic_Dist + (1|pop) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) 
surv_GD_fits_wl2_sub <- surv_GD_fits_sub %>%
  mutate(fit = map(wflow, fit, data = wl2_establishment_scaled))
#show results:
surv_GD_fits_wl2_sub %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value) %>%
  select(-wflow:-group)

#Add in Geo and Gowers clim dist
surv_GD_wflow <- workflow() %>%
  add_variables(outcomes = Establishment, predictors = c(pop, mf, block, contains("GD"), Geographic_Dist)) 
surv_GD_fits <- tibble(wflow=list(
  pop.block = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ (1|pop) + (1|block))},
  
  GS_Recent = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ GD_Recent_GrwSsn_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  GS_Historical = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ GD_Historic_GrwSsn_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Recent = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ GD_Recent_Wtr_Year_2023 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Historical = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Establishment ~ GD_Historic_Wtr_Year_2023 + Geographic_Dist + (1|pop) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) 
surv_GD_fits_wl2 <- surv_GD_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_establishment_scaled))
#show results:
surv_GD_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
```

## First Year Surv Models
```{r}
#basic model workflow 
surv_wflow <- workflow() %>% 
  add_variables(outcomes = Y1Survival, predictors = c(pop, mf, block))
surv_fits <- tibble(wflow=list(
  pop.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ (1|pop) + (1|block))},
  
  pop.mf.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ (1|pop/mf) + (1|block))}
),
name=names(wflow)
) %>% 
  select(name,wflow)
surv_fits_wl2 <- surv_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_y1_surv_scaled))
surv_fits_wl2 %>% filter(name=="pop.mf.block") %>% pull(fit) #no issues with mf 

#Add in Geo and tmp/ppt dist
surv_GD_wflow_sub <- workflow() %>%
  add_variables(outcomes = Y1Survival, predictors = c(pop, mf, block, contains("Dist"))) 
surv_GD_fits_sub <- tibble(wflow=list(
  pop.block = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ (1|pop/mf) + (1|block))},
  
  GS_Recent = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ TempDist_Recent_GrwSsn_2023 + PPTDist_Recent_GrwSsn_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  GS_Historical = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ TempDist_Historic_GrwSsn_2023 + PPTDist_Historic_GrwSsn_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ TempDist_Recent_Wtr_Year_2023 + PPTDist_Recent_Wtr_Year_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_sub %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ TempDist_Historic_Wtr_Year_2023 + PPTDist_Historic_Wtr_Year_2023 + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) 
surv_GD_fits_wl2_sub <- surv_GD_fits_sub %>%
  mutate(fit = map(wflow, fit, data = wl2_y1_surv_scaled))
surv_GD_fits_wl2_sub %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value) %>%
  select(-wflow:-group)

#Add in Geo and Gowers clim dist
surv_GD_wflow <- workflow() %>%
  add_variables(outcomes = Y1Survival, predictors = c(pop, mf, block, contains("GD"), Geographic_Dist)) 
surv_GD_fits <- tibble(wflow=list(
  pop.block = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ (1|pop/mf) + (1|block))},
  
  GS_Recent = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ GD_Recent_GrwSsn_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  GS_Historical = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ GD_Historic_GrwSsn_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Recent = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ GD_Recent_Wtr_Year_2023 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {surv_GD_wflow %>% 
      add_model(glmer.model_binomial, formula = Y1Survival ~ GD_Historic_Wtr_Year_2023 + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) 
surv_GD_fits_wl2 <- surv_GD_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_y1_surv_scaled))
surv_GD_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
```

## Winter Surv Models
```{r}
#basic model workflow 
surv_wflow <- workflow() %>% 
  add_variables(outcomes = WinterSurv, predictors = c(pop, mf, block))
surv_fits <- tibble(wflow=list(
  pop.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ (1|pop) + (1|block))},
  
  pop.mf.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ (1|pop/mf) + (1|block))}
),
name=names(wflow)
) %>% 
  select(name,wflow)
surv_fits_wl2 <- surv_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_winter_surv_scaled))
surv_fits_wl2 %>% filter(name=="pop.mf.block") %>% pull(fit) #nothing wrong with the full model, so use that 

#Add in Geo and tmp/ppt dist
surv_GD_wflow_wl2_sub <- workflow() %>%
  add_variables(outcomes = WinterSurv, predictors = c(pop, mf, block, contains("Dist"))) 
surv_GD_fits_wl2_sub <- tibble(wflow=list(
  pop.mf.block = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ (1|pop/mf) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ TempDist_Recent_Wtr_Year_2024 + PPTDist_Recent_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ TempDist_Historic_Wtr_Year_2024 + PPTDist_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_winter_surv_scaled))
surv_GD_fits_wl2_sub %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value) %>%
  select(-wflow:-group)

#Add in Geo and Gowers clim dist
surv_GD_wflow_wl2 <- workflow() %>%
  add_variables(outcomes = WinterSurv, predictors = c(pop, mf, block, contains("GD"), Geographic_Dist)) 
surv_GD_fits_wl2 <- tibble(wflow=list(
  pop.mf.block = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ (1|pop/mf) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ GD_Recent_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = WinterSurv ~ GD_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_winter_surv_scaled))
surv_GD_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
```

## Surv to Buds Y2 Models
```{r}
#basic model workflow 
surv_wflow <- workflow() %>% 
  add_variables(outcomes = SurvtoRep_y2, predictors = c(pop, mf, block))
surv_fits <- tibble(wflow=list(
  pop.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ (1|pop) + (1|block))},
  
  pop.mf.block = {surv_wflow %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ (1|pop/mf) + (1|block))}
),
name=names(wflow)
) %>% 
  select(name,wflow)
surv_fits_wl2 <- surv_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_surv_to_rep_y2_scaled))
surv_fits_wl2 %>% filter(name=="pop.mf.block") %>% pull(fit) 
#convergence issues with mf included 

#Add in Geo and tmp/ppt dist
surv_GD_wflow_wl2_sub <- workflow() %>%
  add_variables(outcomes = SurvtoRep_y2, predictors = c(pop, mf, block, contains("Dist"))) 
surv_GD_fits_wl2_sub <- tibble(wflow=list(
  pop.block = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ (1|pop) + (1|block))},
  
  GS_Recent = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ TempDist_Recent_GrwSsn_2024 + PPTDist_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  GS_Historical = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ TempDist_Historic_GrwSsn_2024 + PPTDist_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ TempDist_Recent_Wtr_Year_2024 + PPTDist_Recent_Wtr_Year_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_wl2_sub %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ TempDist_Historic_Wtr_Year_2024 + PPTDist_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_surv_to_rep_y2_scaled))
surv_GD_fits_wl2_sub %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value) %>%
  select(-wflow:-group)

#Add in Geo and Gowers clim dist
surv_GD_wflow_wl2 <- workflow() %>%
  add_variables(outcomes = SurvtoRep_y2, predictors = c(pop, mf, block, contains("GD"), Geographic_Dist)) 
surv_GD_fits_wl2 <- tibble(wflow=list(
  pop.block = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ (1|pop) + (1|block))},
  
  GS_Recent = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ GD_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  GS_Historical = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ GD_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Recent = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ GD_Recent_Wtr_Year_2024 + Geographic_Dist + (1|pop) + (1|block))},
  
  WY_Historical = {surv_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = SurvtoRep_y2 ~ GD_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_surv_to_rep_y2_scaled))
#show results:
surv_GD_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
# recent water year = marginally sig, historical water year = sig, but historical water year had a singular boundary warning 
```

## Fruit N Y2 Models
```{r}
#base models:
fruits_modelslog <- tribble(
  ~name,          ~f,
  "1_pop.block",        "logFruits ~ (1|pop) + (1|block)", 
  "2_pop.mf.block",     "logFruits ~  (1|pop/mf) + (1|block)"
)
#run the models 
fruits_modelslog <- fruits_modelslog %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_fruits_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
fruits_modelslog %>% mutate(tidy=map(lmer, tidy, effects = "ran_pars", scales = "vcov")) %>% unnest(tidy) %>% 
  select(name, group, estimate)

#Add in Geo and tmp/ppt dist
fruits_models_log_CD_GD_sub <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logFruits ~  (1|pop/mf) + (1|block)", 
  "2_GS_Recent",      "logFruits ~  TempDist_Recent_GrwSsn_2024 + PPTDist_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "3_GS_Historical",  "logFruits ~  TempDist_Historic_GrwSsn_2024 + PPTDist_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "4_WY_Recent",      "logFruits ~  TempDist_Recent_Wtr_Year_2024 + PPTDist_Recent_Wtr_Year_2024 + Geographic_Dist +(1|pop/mf) + (1|block)",
  "5_WY_Historical",  "logFruits ~  TempDist_Historic_Wtr_Year_2024 + PPTDist_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block)"
)
#run the models 
fruits_models_log_CD_GD_sub <- fruits_models_log_CD_GD_sub %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_fruits_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#boundary (singular) fit: see help('isSingular') warning for all models with climate distance 
#show results:
fruits_models_log_CD_GD_sub %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term:p.value) %>% 
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value)

#Add in Geo and Gowers clim dist
fruits_models_log_CD_GD <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logFruits ~  (1|pop/mf) + (1|block)", 
  "2_GS_Recent",      "logFruits ~  GD_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "3_GS_Historical",  "logFruits ~  GD_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "4_WY_Recent",      "logFruits ~  GD_Recent_Wtr_Year_2024 + Geographic_Dist +(1|pop/mf) + (1|block)",
  "5_WY_Historical",  "logFruits ~  GD_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block)"
)
#run the models 
fruits_models_log_CD_GD <- fruits_models_log_CD_GD %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_fruits_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#show results:
fruits_models_log_CD_GD %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term:p.value) %>% 
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value)
```

## Fruit + Flowers Y2
```{r}
#base models:
FrFlN_modelslog <- tribble(
  ~name,          ~f,
  "1_pop.block",        "logFrFLs ~ (1|pop) + (1|block)", 
  "2_pop.mf.block",     "logFrFLs ~  (1|pop/mf) + (1|block)"
)
#run the models 
FrFlN_modelslog <- FrFlN_modelslog %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_FrFlN_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
FrFlN_modelslog %>% mutate(tidy=map(lmer, tidy, effects = "ran_pars", scales = "vcov")) %>% unnest(tidy) %>% 
  select(name, group, estimate)

#Add in Geo and tmp/ppt dist
FrFlN_models_log_CD_GD_sub <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logFrFLs ~  (1|pop/mf) + (1|block)", 
  "2_GS_Recent",      "logFrFLs ~  TempDist_Recent_GrwSsn_2024 + PPTDist_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "3_GS_Historical",  "logFrFLs ~  TempDist_Historic_GrwSsn_2024 + PPTDist_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "4_WY_Recent",      "logFrFLs ~  TempDist_Recent_Wtr_Year_2024 + PPTDist_Recent_Wtr_Year_2024 + Geographic_Dist +(1|pop/mf) + (1|block)",
  "5_WY_Historical",  "logFrFLs ~  TempDist_Historic_Wtr_Year_2024 + PPTDist_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block)"
)
#run the models 
FrFlN_models_log_CD_GD_sub <- FrFlN_models_log_CD_GD_sub %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_FrFlN_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#boundary (singular) fit: see help('isSingular') warning for all models with climate distance 
#show results:
FrFlN_models_log_CD_GD_sub %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term:p.value) %>% 
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value)

#Add in Geo and Gowers clim dist
FrFlN_models_log_CD_GD <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logFrFLs ~  (1|pop/mf) + (1|block)", 
  "2_GS_Recent",      "logFrFLs ~  GD_Recent_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "3_GS_Historical",  "logFrFLs ~  GD_Historic_GrwSsn_2024 + Geographic_Dist + (1|pop/mf) + (1|block)", 
  "4_WY_Recent",      "logFrFLs ~  GD_Recent_Wtr_Year_2024 + Geographic_Dist +(1|pop/mf) + (1|block)",
  "5_WY_Historical",  "logFrFLs ~  GD_Historic_Wtr_Year_2024 + Geographic_Dist + (1|pop/mf) + (1|block)"
)
#run the models 
FrFlN_models_log_CD_GD <- FrFlN_models_log_CD_GD %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_FrFlN_y2_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#show results:
FrFlN_models_log_CD_GD %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term:p.value) %>% 
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value)
```

## Prob Fruits Models
```{r}
#basic model workflow:
prob_fitness_wflow <- workflow() %>% 
  add_variables(outcomes = ProbFitness, predictors = c(pop, mf, block))
prob_fitness_fits <- tibble(wflow=list(
  
  pop.block = {prob_fitness_wflow %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ (1|pop) + (1|block))},
  
  pop.mf.block = {prob_fitness_wflow %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ (1|pop/mf) + (1|block))}
),
name=names(wflow)
) %>% 
  select(name,wflow)
prob_fitness_fits <- prob_fitness_fits %>%
  mutate(fit = map(wflow, fit, data = wl2_prob_fitness_scaled))
prob_fitness_fits %>% pull(fit) 
#convergence issue with pop.block model 

#Add in geo and temp/ppt distance
prob_fitness_SUB_wflow_wl2 <- workflow() %>%
  add_variables(outcomes = ProbFitness, predictors = c(pop, mf, block, contains("Dist"))) 
prob_fitness_SUB_fits_wl2 <- tibble(wflow=list(
  pop.block = {prob_fitness_SUB_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ (1|pop/mf) + (1|block))},
  
  GS_Recent = {prob_fitness_SUB_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgTempDist_Recent_GrwSsn + AvgPPTDist_Recent_GrwSsn+ Geographic_Dist + (1|pop/mf) + (1|block))},
  
  GS_Historical = {prob_fitness_SUB_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgTempDist_Historic_GrwSsn + AvgPPTDist_Historic_GrwSsn + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Recent = {prob_fitness_SUB_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgTempDist_Recent_Wtr_Year + AvgPPTDist_Recent_Wtr_Year + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {prob_fitness_SUB_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgTempDist_Historic_Wtr_Year + AvgPPTDist_Historic_Wtr_Year + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_prob_fitness_scaled))
#show results:
prob_fitness_SUB_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "Dist") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
prob_fitness_SUB_fits_wl2 %>% pull(fit) #convergence issues with GS_Historical model 

#Add in geo and Gowers clim distance
prob_fitness_GD_wflow_wl2 <- workflow() %>%
  add_variables(outcomes = ProbFitness, predictors = c(pop, mf, block, contains("GD"), Geographic_Dist)) 
prob_fitness_GD_fits_wl2 <- tibble(wflow=list(
  pop.block = {prob_fitness_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ (1|pop/mf) + (1|block))},
  
  GS_Recent = {prob_fitness_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgGD_Recent_GrwSsn + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  GS_Historical = {prob_fitness_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgGD_Historic_GrwSsn + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Recent = {prob_fitness_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgGD_Recent_Wtr_Year + Geographic_Dist + (1|pop/mf) + (1|block))},
  
  WY_Historical = {prob_fitness_GD_wflow_wl2 %>% 
      add_model(glmer.model_binomial, formula = ProbFitness ~ AvgGD_Historic_Wtr_Year + Geographic_Dist + (1|pop/mf) + (1|block))}
  
),
name=names(wflow)
) %>% 
  select(name,wflow) %>%
  mutate(fit = map(wflow, fit, data = wl2_prob_fitness_scaled))
#show results:
prob_fitness_GD_fits_wl2 %>% mutate(tidy=map(fit, tidy)) %>% unnest(tidy) %>%
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value) %>%
  select(-wflow:-group)
```

## Total Fruits Models 
```{r}
#base models:
rep_output_modelslog <- tribble(
  ~name,          ~f,
  "1_pop.block",        "logTotalFitness ~ (1|pop) + (1|block)", 
  "2_pop.mf.block",     "logTotalFitness ~  (1|pop/mf) + (1|block)"
)
#run the models 
rep_output_modelslog <- rep_output_modelslog %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_rep_output_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
rep_output_modelslog %>% mutate(tidy=map(lmer, tidy, effects = "ran_pars", scales = "vcov")) %>% unnest(tidy) %>% 
  select(name, group, estimate)

#Add in Geo and temp/ppt dist
rep_output_SUB_models_log_CD_GD <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logTotalFitness ~  (1|pop) + (1|block)", 
  "2_GS_Recent",      "logTotalFitness ~  AvgTempDist_Recent_GrwSsn + AvgPPTDist_Recent_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  "3a_GS_Historical",  "logTotalFitness ~  AvgTempDist_Historic_GrwSsn + AvgPPTDist_Historic_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  #Troubleshoot weird GrwSsn-AvgTemp_Dist results (positive coefficient, but figure indicates it should be neg...):
  "3b_GS_Historical",  "logTotalFitness ~  AvgTempDist_Historic_GrwSsn*AvgPPTDist_Historic_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  "3c_GS_Historical",  "logTotalFitness ~  AvgTempDist_Historic_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  "3d_GS_Historical",  "logTotalFitness ~  AvgPPTDist_Historic_GrwSsn + Geographic_Dist + (1|pop) + (1|block)",
  
  #water year models:
  "4_WY_Recent",      "logTotalFitness ~  AvgTempDist_Recent_Wtr_Year + AvgPPTDist_Recent_Wtr_Year + Geographic_Dist +(1|pop) + (1|block)",
  "5_WY_Historical",  "logTotalFitness ~  AvgTempDist_Historic_Wtr_Year + AvgPPTDist_Historic_Wtr_Year + Geographic_Dist + (1|pop) + (1|block)"
)
#run the models 
rep_output_SUB_models_log_CD_GD <- rep_output_SUB_models_log_CD_GD %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_rep_output_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#some singularity warnings b/c pop explains 0 var in some models 
rep_output_SUB_models_log_CD_GD %>% mutate(tidy=map(lmer, tidy, effects = "ran_pars", scales = "vcov")) %>% unnest(tidy) %>% 
  select(name, group, estimate)
rep_output_SUB_models_log_CD_GD %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term, estimate:p.value) %>% 
  filter(str_detect(term, "Dist")) %>%
  drop_na(p.value)

#Add in Geo and Gowers clim dist
rep_output_models_log_CD_GD <- tribble(
  ~name,          ~f,
  "1_pop.block",      "logTotalFitness ~  (1|pop) + (1|block)", 
  "2_GS_Recent",      "logTotalFitness ~  AvgGD_Recent_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  "3_GS_Historical",  "logTotalFitness ~  AvgGD_Historic_GrwSsn + Geographic_Dist + (1|pop) + (1|block)", 
  "4_WY_Recent",      "logTotalFitness ~  AvgGD_Recent_Wtr_Year + Geographic_Dist +(1|pop) + (1|block)",
  "5_WY_Historical",  "logTotalFitness ~  AvgGD_Historic_Wtr_Year + Geographic_Dist + (1|pop) + (1|block)"
)
#run the models 
rep_output_models_log_CD_GD <- rep_output_models_log_CD_GD %>%
  mutate(lmer = map(f, ~ lmer(as.formula(.), 
                            data = wl2_rep_output_scaled)), #run the models 
         glance = map(lmer, glance)) #glance at the model results
#show results:
rep_output_models_log_CD_GD %>% mutate(tidy=map(lmer, tidy)) %>% unnest(tidy) %>%
  select(name, term:p.value) %>% 
  filter(str_detect(term, "GD") | term=="Geographic_Dist") %>%
  drop_na(p.value)
```
